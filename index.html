<!DOCTYPE html>
<html lang="it">

<head>
    <base target="_top">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <title>Piano Aule by VI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        th {
            text-align: center;
        }

        #loading {
            /* display: inline-block; */


            width: 150px;
            height: 150px;
            /* border: 3px solid rgba(122, 122, 122, .3);
            border-radius: 50%;
            border-top-color: rgb(122, 122, 122); */
            /* border-bottom-color: rgb(122, 122, 122); */

            margin: auto;
            animation: spin 1.5s cubic-bezier(0.6, -0.28, 0.735, 0.045) infinite;
            -webkit-animation: spin 1.5s cubic-bezier(0.6, -0.28, 0.735, 0.045) infinite;
        }

        @keyframes spin {
            to {
                -webkit-transform: rotate(360deg);
            }
        }

        @-webkit-keyframes spin {
            to {
                -webkit-transform: rotate(360deg);
            }
        }
    </style>
    <script>
        var coppie = {};
        var isLoading = true;
        function save(datas) {
            Object.entries(datas).map((entry) => {
                let key = entry[0];
                let value = entry[1];
                coppie[key] = JSON.parse(value);
                coppie[key].events.forEach((ev, index) => {
                    coppie[key].events[index].start = new Date(ev.start);
                    coppie[key].events[index].end = new Date(ev.end);
                })
            })
            coppie = new Map(Object.entries(coppie));
            isLoading = false;
            console.log("Dati recuperati")
        }
        function waitForData() {
            // let searchBtn = document.getElementById("search");
            if (isLoading === true) {
                // searchBtn.setAttribute("disabled", true);
                // searchBtn.value = "Caricando...";
                console.log("Waiting for data...")
                setTimeout(waitForData, 750);
                return;
            }
            else {
                document.getElementById("loading").style.display = "none";
                document.getElementById("list").style.display = "block";

                fetchAuleLibere();
            }
        }
        function fetchAuleLibere(orderBy = null) {
            // let searchBtn = document.getElementById("search");
            // const prevValue = "Cerca!";
            // searchBtn.value = prevValue;
            // searchBtn.removeAttribute("disabled");

            let timesel = document.getElementById("timesel").value;
            let daysel = parseInt(document.getElementById("daysel").value);
            let today = new Date();
            let distance = daysel - today.getDay();
            //TODO: TEST
            today.setDate(today.getDate() + distance);
            today.setHours(timesel);
            today.setMinutes(0);
            today.setSeconds(0);
            console.log(today.toString());
            let auleLibere = [];


            coppie.forEach((data, oid) => {
                const today_events = data.events.filter(ev => ev.start.getDay() === today.getDay());
                if (!today_events.some(ev => ev.start.getHours() <= today.getHours() && today.getHours() < ev.end.getHours())) {
                    // Questa aula è libera. Cerchiamo di capire quando è la prossima lezione
                    let minimum_duration = 20 - today.getHours(); // Lo pongo uguale al massimo teorico
                    today_events.forEach((ev) => {
                        let diff = ev.start.getHours() - today.getHours();
                        minimum_duration = diff > 0 && diff < minimum_duration ? diff : minimum_duration
                    })
                    if (minimum_duration === 20 - today.getHours() && minimum_duration > 10) {
                        data.msg = "L'aula potrebbe essere chiusa :(";
                    }
                    else {
                        data.msg = "";
                    }
                    data.url = "https://offweb.unipa.it/offweb/public/aula/calendar.seam?oidAula=" + parseInt(oid);
                    data.hoursTillNext = minimum_duration;
                    auleLibere.push(data)
                }
            })
            console.log(auleLibere);
            let table = document.getElementById("listtable");
            var tableRows = table.getElementsByTagName('tr');
            var rowCount = tableRows.length;

            for (var x = rowCount - 1; x > 0; x--) {
                table.deleteRow(x);
            }
            if (orderBy === null || orderBy === "duration")
                auleLibere.sort((prev, next) => next.hoursTillNext === prev.hoursTillNext ? next.aula < prev.aula : next.hoursTillNext - prev.hoursTillNext);
            else
                auleLibere.sort((prev, next) => next.aula < prev.aula);

            auleLibere.forEach(aula => {
                let newrow = table.insertRow();
                let cellName = newrow.insertCell()
                let link_element = document.createElement("a");
                link_element.setAttribute("href", aula.url);
                link_element.setAttribute("target", "_blank");
                link_element.innerHTML = aula.aula
                cellName.appendChild(link_element);
                let cellTime = newrow.insertCell();
                cellTime.innerHTML = "" + aula.hoursTillNext + "h";
                let cellMsg = newrow.insertCell();
                cellMsg.innerHTML = aula.msg === undefined ? "" : aula.msg;
            })
        }
        window.addEventListener("load", () => {
            try { google.script.run.withSuccessHandler(save).webifyData(); } catch { }
            let today = new Date();
            // Default Day
            let currD = today.getDay();
            var defaultD = currD < 6 ? currD : 5;
            defaultD = defaultD > 0 ? defaultD : 1;
            const selectList = document.getElementById("daysel");
            selectList.selectedIndex = defaultD - 1;
            // Default Hour
            let currH = today.getHours();
            let defaultH = currH < 19 ? currH : 19;
            defaultH = defaultH > 8 ? defaultH : 8;
            document.getElementById("timesel").selectedIndex = defaultH - 8;
            waitForData()

        })
    </script>
</head>

<body class="text-center center-block">
    <header class="container-fluid">
        <!-- <h1> Piano Aule by VI</h1> -->
        <div id="searcher" class="container-fluid">
            <form action="" method="POST" role="form" class="form-inline" style="width: fit-content; margin:auto">
                <div class="row">
                    <div class="col">
                        <label for="daysel" class="form-label">Seleziona il giorno</label>
                    </div>
                    <div class="col">
                        <select style="max-width: 100px;margin: auto" name="daysel" id="daysel" class="form-control"
                            onchange="waitForData()">
                            <option value="1">Lunedì</option>
                            <option value="2">Martedì</option>
                            <option value="3">Mercoledì</option>
                            <option value="4">Giovedì</option>
                            <option value="5">Venerdì</option>
                        </select>
                    </div>

                </div>
                <div class="row">
                    <div class="col">
                        <label class="form-label" for="timesel">Seleziona l'ora</label>

                    </div>
                    <div class="col">
                        <select style="max-width: 100px;margin: auto" name="timesel" id="timesel"
                            onchange="waitForData()" class="timesel form-control">
                            <option value="8">08:00</option>
                            <option value="9">09:00</option>
                            <option value="10">10:00</option>
                            <option value="11">11:00</option>
                            <option value="12">12:00</option>
                            <option value="13">13:00</option>
                            <option value="14">14:00</option>
                            <option value="15">15:00</option>
                            <option value="16">16:00</option>
                            <option value="17">17:00</option>
                            <option value="18">18:00</option>
                            <option value="19">19:00</option>
                            <option value="20">20:00</option>
                        </select>

                    </div>
                </div>
            </form>
        </div>
    </header>
    <main class="container-fluid" style="margin-top: 20px;">
        <div id="loading" style="margin:auto">
        <img src="https://i.imgur.com/2cp3TAB.png" width="150px" alt="Caricando...">
        </div>
        <div id="list" class="table-responsive" style="display: none;">
            <table class="table table-hover table-bordered table-condensed" id="listtable"
                style="text-align: center;width: fit-content;margin: auto;">
                <thead>
                    <tr>
                        <th onclick="fetchAuleLibere('name')">Aula</th>
                        <th onclick="fetchAuleLibere('duration')">Libera per</th>
                        <th>Note</th>
                    </tr>
                </thead>
            </table>
        </div>
    </main>
</body>

</html>