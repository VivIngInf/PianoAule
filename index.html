<!DOCTYPE html>
<html lang="it">

<head>
    <base target="_top">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <title>Piano Aule by VI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        th {
            text-align: center;
        }

        #loading {
            /* display: inline-block; */


            width: 150px;
            height: 150px;
            /* border: 3px solid rgba(122, 122, 122, .3);
            border-radius: 50%;
            border-top-color: rgb(122, 122, 122); */
            /* border-bottom-color: rgb(122, 122, 122); */

            margin: auto;
            animation: spin 1.5s cubic-bezier(0.6, -0.28, 0.735, 0.045) infinite;
            -webkit-animation: spin 1.5s cubic-bezier(0.6, -0.28, 0.735, 0.045) infinite;
        }

        @keyframes spin {
            to {
                -webkit-transform: rotate(360deg);
            }
        }

        @-webkit-keyframes spin {
            to {
                -webkit-transform: rotate(360deg);
            }
        }
    </style>
    <script>
        var coppie = {};
        var isLoading = true;
        function save(datas) {
            Object.entries(datas).map((entry) => {
                let key = entry[0];
                let value = entry[1];
                coppie[key] = JSON.parse(value);
                coppie[key].events.forEach((ev, index) => {
                    coppie[key].events[index].start = new Date(ev.start);
                    coppie[key].events[index].end = new Date(ev.end);
                })
            })
            coppie = new Map(Object.entries(coppie));
            isLoading = false;
            console.log("Dati recuperati")
        }
        function waitForData() {
            // let searchBtn = document.getElementById("search");
            if (isLoading === true) {
                // searchBtn.setAttribute("disabled", true);
                // searchBtn.value = "Caricando...";
                console.log("Waiting for data...")
                setTimeout(waitForData, 750);
                return;
            }
            else {
                document.getElementById("loading").style.display = "none";
                document.getElementById("list").style.display = "block";

                fetchAuleLibere();
            }
        }
        function fetchAuleLibere(orderBy = null) {
            // let searchBtn = document.getElementById("search");
            // const prevValue = "Cerca!";
            // searchBtn.value = prevValue;
            // searchBtn.removeAttribute("disabled");

            let timesel = document.getElementById("timesel").value;
            let daysel = parseInt(document.getElementById("daysel").value);
            let today = new Date();
            let distance = daysel - today.getDay();
            //TODO: TEST
            today.setDate(today.getDate() + distance);
            today.setHours(timesel);
            today.setMinutes(0);
            today.setSeconds(0);
            console.log(today.toString());
            let auleLibere = [];


            coppie.forEach((data, oid) => {
                let today_events = data.events.filter(ev => ev.start.getDay() === today.getDay());
                data.duration = 21 - today.getHours();
                data.next_event = null;
                if (today_events.length === 0) {
                    data.msg = "Non ci sono lezioni tutta la giornata ü§î";
                }
                else {
                    today_events.sort((a, b) => a.start - b.start) // Ordino temporalmente
                    if (today_events.some(event => (event.start < today && today < event.end))) return;
                    today_events = today_events.filter(event => event.start > today); // Elimino le lezioni precedenti
                    if (today_events.length > 0) {
                        data.next_event = today_events[0];
                        data.duration = data.next_event.start.getHours() - today.getHours();
                    }
                }
                data.url = "https://offweb.unipa.it/offweb/public/aula/calendar.seam?oidAula=" + parseInt(oid);
                auleLibere.push(data)
            })
            console.log(auleLibere);
            let table = document.getElementById("listtable");
            var tableRows = table.getElementsByTagName('tr');
            var rowCount = tableRows.length;

            for (var x = rowCount - 1; x > 0; x--) {
                table.deleteRow(x);
            }
            if (orderBy === null || orderBy === "duration")
                auleLibere.sort((prev, next) => next.duration === prev.duration ? next.aula < prev.aula : next.duration - prev.duration);
            else
                auleLibere.sort((prev, next) => next.aula < prev.aula);

            auleLibere.forEach(aula => {
                let newrow = table.insertRow();
                let cellName = newrow.insertCell()
                let link_element = document.createElement("a");
                link_element.setAttribute("href", aula.url);
                link_element.setAttribute("target", "_blank");
                link_element.innerHTML = aula.aula
                cellName.appendChild(link_element);
                let cellTime = newrow.insertCell();
                if (aula.next_event === null)
                    cellTime.innerHTML = `Domani üòä`
                else
                    cellTime.innerHTML = `${aula.next_event.start.getHours().toString().padStart(2, "0")}:${aula.next_event.start.getMinutes().toString().padStart(2, "0")}`;
                let cellMsg = newrow.insertCell();
                cellMsg.innerHTML = aula.msg === undefined ? "" : aula.msg;
            })
        }
        window.addEventListener("load", () => {
            try {
                google.script.run.withSuccessHandler(save).webifyData();
            }
            catch {
                // Local Testing
                isLoading = false;
                coppie = {
                    '322': {
                        aula: "F130",
                        events: [
                            {
                                "title": "Lezione Prof. GAGLIO SALVATORE - Mod. FONDAMENTI DI PROGRAMMAZIONE",
                                "start": new Date("2022-05-13T09:00:00.000Z"),
                                "end": new Date("2022-05-13T11:00:00.000Z"),
                                "allDay": false,
                                "className": "calendario-lezioni-event-high"
                            },
                            {
                                "title": "Lezione Prof.ssa VALENTI ANGELA - ALGEBRA",
                                "start": new Date("2022-05-13T06:00:00.000Z"),
                                "end": new Date("2022-05-13T09:00:00.000Z"),
                                "allDay": false,
                                "className": "calendario-lezioni-event-high"
                            },
                            {
                                "title": "Lezione Prof. PERI DANIELE - Mod. ARCHITETTURE DI BASE DEI CALCOLATORI",
                                "start": new Date("2022-05-12T08:00:00.000Z"),
                                "end": new Date("2022-05-12T11:00:00.000Z"),
                                "allDay": false,
                                "className": "calendario-lezioni-event-high"
                            },
                            {
                                "title": "Lezione Prof.ssa BRANDOLINI BARBARA - ANALISI MATEMATICA C.I.",
                                "start": new Date("2022-05-12T06:00:00.000Z"),
                                "end": new Date("2022-05-12T08:00:00.000Z"),
                                "allDay": false,
                                "className": "calendario-lezioni-event-high"
                            },
                            {
                                "title": "Lezione Prof. VASSALLO GIORGIO - FISICA I",
                                "start": new Date("2022-05-11T14:00:00.000Z"),
                                "end": new Date("2022-05-11T16:00:00.000Z"),
                                "allDay": false,
                                "className": "calendario-lezioni-event-high"
                            },
                            {
                                "title": "Lezione Prof. PERI DANIELE - Mod. ARCHITETTURE DI BASE DEI CALCOLATORI",
                                "start": new Date("2022-05-11T12:00:00.000Z"),
                                "end": new Date("2022-05-11T14:00:00.000Z"),
                                "allDay": false,
                                "className": "calendario-lezioni-event-high"
                            },
                            {
                                "title": "Lezione Prof.ssa FRANCOMANO ELISA - METODI NUMERICI",
                                "start": new Date("2022-05-11T07:00:00.000Z"),
                                "end": new Date("2022-05-11T10:00:00.000Z"),
                                "allDay": false,
                                "className": "calendario-lezioni-event-normal"
                            },
                            {
                                "title": "Lezione Prof.ssa BRANDOLINI BARBARA - ANALISI MATEMATICA C.I.",
                                "start": new Date("2022-05-10T12:00:00.000Z"),
                                "end": new Date("2022-05-10T15:00:00.000Z"),
                                "allDay": false,
                                "className": "calendario-lezioni-event-high"
                            },
                            {
                                "title": "Lezione Prof. SORBELLO ROSARIO - BASI DI DATI E SISTEMI INFORMATIVI",
                                "start": new Date("2022-05-10T09:00:00.000Z"),
                                "end": new Date("2022-05-10T11:00:00.000Z"),
                                "allDay": false,
                                "className": "calendario-lezioni-event-normal"
                            },
                            {
                                "title": "Lezione Prof.ssa FRANCOMANO ELISA - METODI NUMERICI",
                                "start": new Date("2022-05-10T07:00:00.000Z"),
                                "end": new Date("2022-05-10T09:00:00.000Z"),
                                "allDay": false,
                                "className": "calendario-lezioni-event-normal"
                            },
                            {
                                "title": "Lezione Prof. VASSALLO GIORGIO - FISICA I",
                                "start": new Date("2022-05-09T14:00:00.000Z"),
                                "end": new Date("2022-05-09T16:00:00.000Z"),
                                "allDay": false,
                                "className": "calendario-lezioni-event-high"
                            },
                            {
                                "title": "Lezione Prof.ssa VALENTI ANGELA - ALGEBRA",
                                "start": new Date("2022-05-09T12:00:00.000Z"),
                                "end": new Date("2022-05-09T14:00:00.000Z"),
                                "allDay": false,
                                "className": "calendario-lezioni-event-high"
                            },
                            {
                                "title": "Lezione Prof. SORBELLO ROSARIO - BASI DI DATI E SISTEMI INFORMATIVI",
                                "start": new Date("2022-05-09T08:00:00.000Z"),
                                "end": new Date("2022-05-09T11:00:00.000Z"),
                                "allDay": false,
                                "className": "calendario-lezioni-event-normal"
                            },
                            {
                                "title": "Lezione Prof.ssa FRANCOMANO ELISA - METODI NUMERICI",
                                "start": new Date("2022-05-09T06:00:00.000Z"),
                                "end": new Date("2022-05-09T08:00:00.000Z"),
                                "allDay": false,
                                "className": "calendario-lezioni-event-normal"
                            }
                        ]
                    }
                }
                coppie = new Map(Object.entries(coppie));
            }
            let today = new Date();
            // Default Day
            let currD = today.getDay();
            var defaultD = currD < 6 ? currD : 5;
            defaultD = defaultD > 0 ? defaultD : 1;
            const selectList = document.getElementById("daysel");
            selectList.selectedIndex = defaultD - 1;
            // Default Hour
            let currH = today.getHours();
            let defaultH = currH < 19 ? currH : 19;
            defaultH = defaultH > 8 ? defaultH : 8;
            document.getElementById("timesel").selectedIndex = defaultH - 8;
            waitForData()

        })
    </script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Y14PHH0JFE"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-Y14PHH0JFE');
    </script>
</head>

<body class="text-center center-block">
    <header class="container-fluid">
        <!-- <h1> Piano Aule by VI</h1> -->
        <div id="searcher" class="container-fluid">
            <form action="" method="POST" role="form" class="form-inline" style="width: fit-content; margin:auto">
                <div class="row">
                    <div class="col">
                        <label for="daysel" class="form-label">Seleziona il giorno</label>
                    </div>
                    <div class="col">
                        <select style="max-width: 100px;margin: auto" name="daysel" id="daysel" class="form-control"
                            onchange="waitForData()">
                            <option value="1">Luned√¨</option>
                            <option value="2">Marted√¨</option>
                            <option value="3">Mercoled√¨</option>
                            <option value="4">Gioved√¨</option>
                            <option value="5">Venerd√¨</option>
                        </select>
                    </div>

                </div>
                <div class="row">
                    <div class="col">
                        <label class="form-label" for="timesel">Seleziona l'ora</label>

                    </div>
                    <div class="col">
                        <select style="max-width: 100px;margin: auto" name="timesel" id="timesel"
                            onchange="waitForData()" class="timesel form-control">
                            <option value="8">08:00</option>
                            <option value="9">09:00</option>
                            <option value="10">10:00</option>
                            <option value="11">11:00</option>
                            <option value="12">12:00</option>
                            <option value="13">13:00</option>
                            <option value="14">14:00</option>
                            <option value="15">15:00</option>
                            <option value="16">16:00</option>
                            <option value="17">17:00</option>
                            <option value="18">18:00</option>
                            <option value="19">19:00</option>
                            <option value="20">20:00</option>
                        </select>

                    </div>
                </div>
            </form>
        </div>
    </header>
    <main class="container-fluid" style="margin-top: 20px;">
        <div id="loading" style="margin:auto">
            <img src="https://i.imgur.com/2cp3TAB.png" width="150px" alt="Caricando...">
        </div>
        <div id="list" class="table-responsive" style="display: none;">
            <table class="table table-hover table-bordered table-condensed" id="listtable"
                style="text-align: center;width: fit-content;margin: auto;">
                <thead>
                    <tr>
                        <th onclick="fetchAuleLibere('name')">Aula</th>
                        <th onclick="fetchAuleLibere('duration')">Libera fino alle</th>
                        <th>Note</th>
                    </tr>
                </thead>
            </table>
        </div>
    </main>
</body>

</html>